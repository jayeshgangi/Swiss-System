<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Tournament Dashboard</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>
body {
    background: url('{{ url_for('static', filename='chessboard.jpg') }}') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    color: #fff;
}
.navbar-custom {
    background-color: rgba(0, 0, 0, 0.7);
}
.navbar-custom .navbar-brand,
.navbar-custom .nav-link {
    color: #fff;
}
.navbar-custom .nav-link:hover {
    color: #00f2fe;
}
.container-dashboard {
    margin-top: 80px;
    text-align: center;
}
.btn-dashboard {
    margin: 15px;
    width: 200px;
    font-size: 1.1rem;
}
#tournamentListBox {
    margin-top: 40px;
}
.card .card-body div {
    text-align: center;
}
.tournament-card-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 15px;
}
.tournament-name {
    flex: 1;
    text-align: left;
    font-weight: bold;
    font-size: 1.1rem;
}
.tournament-stats {
    flex: 2;
    text-align: center;
    font-size: 0.95rem;
}
.tournament-actions {
    flex: 1;
    text-align: right;
    display: flex;
    gap: 5px;
    justify-content: flex-end;
}
/* ✅ New styles for participant display */
.participant-count-badge {
    display: inline-block;
    background-color: #198754;
    color: white;
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 0.85rem;
    font-weight: bold;
    margin-left: 10px;
}
</style>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-custom fixed-top">
  <div class="container-fluid">
    <a class="navbar-brand" href="#">Swiss System Dashboard</a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarButtons" aria-controls="navbarButtons" aria-expanded="false" aria-label="Toggle navigation">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse" id="navbarButtons">
      <ul class="navbar-nav ms-auto mb-2 mb-lg-0">
        <li class="nav-item"><a class="nav-link" href="#" onclick="showTournamentList()">Tournaments List</a></li>
        <li class="nav-item"><a class="nav-link" href="{{ url_for('setuptournament') }}">Add Tournaments</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Edit Tournaments</a></li>
        <li class="nav-item"><a class="nav-link" href="#">Delete Tournaments</a></li>
        <li class="nav-item"><a class="nav-link" href="#" onclick="showStandingsSelector()">Standings</a></li>
        <li class="nav-item"><a class="nav-link" href="{{url_for('rounds')}}">Rounds</a></li>
      </ul>
    </div>
  </div>
</nav>

<div class="container-dashboard">
    <h1 class="mb-4">Tournament Management</h1>
    <button class="btn btn-info btn-dashboard" onclick="showTournamentList()">Tournaments List</button>
    <a href="{{ url_for('setuptournament') }}" class="btn btn-info btn-dashboard">Add Tournaments</a>
    <a href="#" class="btn btn-info btn-dashboard">Edit Tournaments</a>
    <a href="#" class="btn btn-info btn-dashboard">Delete Tournaments</a>
    <button class="btn btn-info btn-dashboard" onclick="showStandingsSelector()">Standings</button>
    <a href="{{ url_for('rounds')}}" class="btn btn-info btn-dashboard">Rounds</a>

    <!-- RESULT BOX -->
    <div id="tournamentListBox"></div>
</div>

<script>
const participantsData = {}; // global store

function showTournamentList() {
    fetch("/api/tournaments")
    .then(response => response.json())
    .then(data => {
        let box = document.getElementById("tournamentListBox");
        if (!data.tournaments || data.tournaments.length === 0) {
            box.innerHTML = `<div class="alert alert-warning mt-4">No tournaments saved.</div>`;
            return;
        }

        let html = `<div class="card bg-dark text-white mt-4 p-3">
                        <h4 class="mb-3">Saved Tournaments</h4>
                        <div class="text-center mb-2" style="font-size: 0.9rem; color: #aaa;">
                            <span>Rounds | Max Players | Uploaded | Win | Draw | Loss</span>
                        </div>`;

        // ✅ Load participant counts for all tournaments
        const participantPromises = data.tournaments.map(t => 
            fetch(`/api/tournament/${encodeURIComponent(t.name)}/participant-count`)
                .then(res => res.json())
                .catch(() => ({count: 0}))
        );

        Promise.all(participantPromises).then(participantCounts => {
            data.tournaments.forEach((t, index) => {
                const safeName = t.name.replace(/\W/g,'');
                const uploadedCount = participantCounts[index].count || 0;

                html += `
                <div class="card bg-light text-dark mb-3">
                    <div class="card-body tournament-card-header">
                        <div class="tournament-name">
                            ${t.name}
                        </div>
                        <div class="tournament-stats">${t.rounds} | ${t.players} | ${uploadedCount} | ${t.win_points} | ${t.draw_points} | ${t.loss_points}</div>
                        <div class="tournament-actions">
                            <button class="btn btn-sm btn-primary" data-bs-toggle="collapse" data-bs-target="#participantsForm-${safeName}" 
                                    onclick="loadExistingParticipants('${t.name}')">
                                Add Participants
                            </button>
                            <button class="btn btn-sm btn-success" onclick="loadTournamentRounds('${t.name}', ${t.id})">
                                Rounds
                            </button>
                            <button class="btn btn-sm btn-info" onclick="loadStandings('${t.name}')">
                                Standings
                            </button>
                        </div>
                    </div>

                    <div class="collapse mt-2" id="participantsForm-${safeName}">
                        <div class="card card-body bg-secondary text-white">
                            <!-- Single Participant Form -->
                            <form onsubmit="return addParticipant('${t.name}', ${t.players})" class="mb-2">
                                <div class="row g-2 align-items-center">
                                    <div class="col">
                                        <input type="text" class="form-control form-control-sm" placeholder="Name" id="pname-${safeName}" required>
                                    </div>
                                    <div class="col">
                                        <input type="number" class="form-control form-control-sm" placeholder="ELO" id="pelo-${safeName}" required>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-sm btn-success">Add</button>
                                    </div>
                                </div>
                            </form>

                            <!-- Bulk Upload Form -->
                            <form onsubmit="return bulkUpload('${t.name}', ${t.players})" enctype="multipart/form-data" class="mb-2">
                                <div class="row g-2 align-items-center">
                                    <div class="col">
                                        <input type="file" class="form-control form-control-sm" id="bulkFile-${safeName}" accept=".csv,.xlsx" required>
                                    </div>
                                    <div class="col-auto">
                                        <button type="submit" class="btn btn-sm btn-warning">Upload Excel</button>
                                    </div>
                                </div>
                            </form>

                            <!-- Participants List -->
                            <ul class="mt-2 list-group" id="participantsList-${safeName}"></ul>

                            <!-- Save Button -->
                            <button class="btn btn-sm btn-info mt-2" style="width: 100px;" onclick="saveParticipantsToDB('${t.name}')">Save</button>
                        </div>
                    </div>
                </div>`;
            });

            html += `</div>`;
            box.innerHTML = html;
        });
    });
}

function loadExistingParticipants(tname) {
    const safeName = tname.replace(/\W/g,'');
    
    fetch(`/api/tournament/${encodeURIComponent(tname)}/participants`)
    .then(res => res.json())
    .then(data => {
        if (data.participants && data.participants.length > 0) {
            participantsData[tname] = data.participants;
            
            const list = document.getElementById(`participantsList-${safeName}`);
            list.innerHTML = participantsData[tname]
                .map(p => `<li class="list-group-item d-flex justify-content-between bg-dark text-white">${p.name} <span>${p.elo}</span></li>`)
                .join('');
        }
    })
    .catch(err => console.error("Error loading participants:", err));
}


function loadTournamentRounds(tname, tid) {
    fetch(`/api/tournament/${tid}/rounds`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        // ⭐ REDIRECT TO ROUNDS PAGE IF NO ROUNDS EXIST
        if (!data.rounds || data.rounds.length === 0) {
            if (confirm(`No rounds generated for "${tname}" yet.\n\nRedirect to Rounds page to generate?`)) {
                window.location.href = `/rounds?tournament_id=${tid}`;
            }
            return;
        }

        let box = document.getElementById("tournamentListBox");
        let html = `
        <div class="card bg-dark text-white mt-4 p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>${tname} - Rounds</h4>
                <span class="badge bg-success fs-6">${data.rounds.length} Round(s)</span>
            </div>`;

        data.rounds.forEach(round => {
            html += `
            <div class="card bg-secondary text-white mb-3">
                <div class="card-header bg-primary">
                    <h5 class="mb-0">Round ${round.round_number}</h5>
                </div>
                <div class="card-body">
                    <table class="table table-dark table-sm table-hover">
                        <thead>
                            <tr>
                                <th>White</th>
                                <th>Black</th>
                                <th>Result</th>
                            </tr>
                        </thead>
                        <tbody>`;

            round.pairings.forEach(pairing => {
    let resultBadge = '';
    if (pairing.result === 'white') {
        resultBadge = '<span class="badge bg-success">White Won</span>';
    } else if (pairing.result === 'black') {
        resultBadge = '<span class="badge bg-success">Black Won</span>';
    } else if (pairing.result === 'draw') {
        resultBadge = '<span class="badge bg-warning text-dark">Draw</span>';
    } else if (pairing.result === 'bye_white') {
        resultBadge = '<span class="badge bg-info">White BYE Win</span>';
    } else if (pairing.result === 'bye_black') {
        resultBadge = '<span class="badge bg-info">Black BYE Win</span>';
    } else {
        resultBadge = '<span class="badge bg-secondary">Pending</span>';
    }

    html += `
    <tr>
        <td>${pairing.white_name}</td>
        <td>${pairing.black_name}</td>
        <td>${resultBadge}</td>
    </tr>`;
});

            html += `
                        </tbody>
                    </table>
                </div>
            </div>`;
        });

        html += `
            <button class="btn btn-outline-light mt-2" onclick="showTournamentList()">← Back</button>
        </div>`;
        
        box.innerHTML = html;
    })
    .catch(err => {
        console.error("Error loading rounds:", err);
        alert("Failed to load rounds");
    });
}

function showStandingsSelector() {
    fetch("/api/tournaments")
    .then(response => response.json())
    .then(data => {
        let box = document.getElementById("tournamentListBox");
        if (!data.tournaments || data.tournaments.length === 0) {
            box.innerHTML = `<div class="alert alert-warning mt-4">No tournaments available.</div>`;
            return;
        }

        let html = `<div class="card bg-dark text-white mt-4 p-3">
            <h4 class="mb-3">Select Tournament for Standings</h4>
            <div class="list-group">`;

        data.tournaments.forEach(t => {
            html += `<button class="list-group-item list-group-item-action bg-secondary text-white mb-2" 
                     onclick="loadStandings('${t.name}')">${t.name} (${t.rounds} rounds, ${t.players} players)</button>`;
        });

        html += `</div></div>`;
        box.innerHTML = html;
    });
}

function loadStandings(tname) {
    fetch(`/api/tournament/${encodeURIComponent(tname)}/standings`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            return;
        }

        let box = document.getElementById("tournamentListBox");
        let html = `
        <div class="card bg-dark text-white mt-4 p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>${data.tournament} - Standings</h4>
                <span class="badge bg-info fs-6">Round ${data.current_round} of ${data.total_rounds}</span>
            </div>
            <div class="table-responsive">
                <table class="table table-dark table-striped table-hover">
                    <thead class="table-success text-dark">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>ELO</th>
                            <th>Score</th>
                            <th>Buchholz</th>
                            <th>Buch Cut-1</th>
                            <th>Games</th>
                            <th>W/B</th>
                        </tr>
                    </thead>
                    <tbody>`;

        data.standings.forEach(player => {
            html += `
                <tr>
                    <td>${player.rank}</td>
                    <td>${player.name}</td>
                    <td>${player.elo}</td>
                    <td><strong>${player.score}</strong></td>
                    <td>${player.buchholz.toFixed(1)}</td>
                    <td>${player.buchholz_cut1.toFixed(1)}</td>
                    <td>${player.games_played}</td>
                    <td>${player.white_count}/${player.black_count}</td>
                </tr>`;
        });

        html += `</tbody></table></div>
            <button class="btn btn-outline-light mt-2" onclick="showTournamentList()">← Back</button>
        </div>`;
        
        box.innerHTML = html;
    })
    .catch(err => {
        console.error("Error loading standings:", err);
        alert("Failed to load standings");
    });
}

// ------------------- Global functions -------------------

function addParticipant(tname) {
    const safeName = tname.replace(/\W/g,'');
    const nameId = `pname-${safeName}`;
    const eloId = `pelo-${safeName}`;

    const name = document.getElementById(nameId).value.trim();
    const elo = document.getElementById(eloId).value.trim();
    
    if (!name || !elo) {
        alert("Please enter both name and ELO");
        return false;
    }

    // ✅ Initialize participantsData if not exists
    if (!participantsData[tname]) {
        participantsData[tname] = [];
    }

    // ✅ Get max players from tournament data (need to fetch this)
    fetch("/api/tournaments")
    .then(response => response.json())
    .then(data => {
        const tournament = data.tournaments.find(t => t.name === tname);
        const maxPlayers = tournament ? tournament.players : 100;

        if (participantsData[tname].length >= maxPlayers) {
            alert(`Maximum ${maxPlayers} players allowed!`);
            return false;
        }

        // ✅ Check for duplicates
        const isDuplicate = participantsData[tname].some(p => p.name === name);
        if (isDuplicate) {
            alert(`Player "${name}" already exists!`);
            return false;
        }

        participantsData[tname].push({name, elo: parseInt(elo)});
        
        const list = document.getElementById(`participantsList-${safeName}`);
        if (list) {
            list.innerHTML = participantsData[tname]
                .map(p => `<li class="list-group-item d-flex justify-content-between bg-dark text-white">${p.name} <span>${p.elo}</span></li>`)
                .join('');
        }

        // Clear inputs
        document.getElementById(nameId).value = '';
        document.getElementById(eloId).value = '';
    });

    return false;
}

function saveParticipantsToDB(tname) {
    if (!participantsData[tname] || participantsData[tname].length === 0) {
        alert("No participants to save!");
        return;
    }

    fetch(`/api/tournament/${tname}/participants`, {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify(participantsData[tname])
    })
    .then(res => res.json())
    .then(data => {
        if (data.status === "ok") {
            alert("Participants saved successfully");
            showTournamentList();
        } else {
            alert("Error saving participants!");
        }
    })
    .catch(err => {
        console.error("Error saving participants:", err);
    });
}

function bulkUpload(tname, maxPlayers) {
    if (window.event) {
        event.preventDefault();
        event.stopPropagation();
    }
    
    const safeName = tname.replace(/\W/g,'');
    const fileInput = document.getElementById(`bulkFile-${safeName}`);
    const file = fileInput.files[0];
    
    if (!file) {
        alert("Please select a file first");
        return false;
    }

    const fileName = file.name.toLowerCase();
    if (!fileName.endsWith('.xlsx') && !fileName.endsWith('.xls') && !fileName.endsWith('.csv')) {
        alert("Please upload only Excel (.xlsx, .xls) or CSV (.csv) files");
        return false;
    }

    const reader = new FileReader();

    reader.onload = function(e) {
        try {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, { type: 'array' });
            const sheetName = workbook.SheetNames[0];
            const sheet = workbook.Sheets[sheetName];
            const rows = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: '' });

            console.log("Parsed rows:", rows);

            // ✅ Initialize participantsData if not exists
            if (!participantsData[tname]) {
                participantsData[tname] = [];
            }

            let addedCount = 0;
            let skippedCount = 0;

            for (let i = 0; i < rows.length; i++) {
                // ✅ Check if max players reached
                if (participantsData[tname].length >= maxPlayers) {
                    alert(`Maximum ${maxPlayers} players reached. Some entries were skipped.`);
                    break;
                }

                const row = rows[i];
                
                // ✅ Skip empty rows
                if (!row || row.length === 0) {
                    continue;
                }

                const name = row[0] ? row[0].toString().trim() : '';
                const elo = row[1] ? row[1].toString().trim() : '';

                // ✅ Skip rows with missing data
                if (!name || !elo) {
                    console.log(`Skipping row ${i + 1}: empty name or ELO`);
                    skippedCount++;
                    continue;
                }

                // ✅ Validate ELO is a number
                if (isNaN(elo) || elo === '') {
                    console.log(`Skipping row ${i + 1}: "${name}" - invalid ELO "${elo}"`);
                    skippedCount++;
                    continue;
                }

                // ✅ Check for duplicates
                const isDuplicate = participantsData[tname].some(p => p.name === name);
                if (isDuplicate) {
                    console.log(`Skipping row ${i + 1}: "${name}" - duplicate`);
                    skippedCount++;
                    continue;
                }

                // ✅ Add participant
                participantsData[tname].push({ 
                    name: name, 
                    elo: parseInt(elo) // Convert to integer
                });
                addedCount++;
                console.log(`Added: ${name} - ${elo}`);
            }

            // ✅ Update the displayed list
            const list = document.getElementById(`participantsList-${safeName}`);
            if (list) {
                list.innerHTML = participantsData[tname]
                    .map(p => `<li class="list-group-item d-flex justify-content-between bg-dark text-white">${p.name} <span>${p.elo}</span></li>`)
                    .join('');
            }
            
            console.log("Total participants:", participantsData[tname]);
            
            // ✅ Show summary
            let message = `Successfully loaded ${addedCount} participant(s)`;
            if (skippedCount > 0) {
                message += `\n${skippedCount} row(s) skipped (empty, invalid, or duplicate)`;
            }
            if (addedCount > 0) {
                alert(message);
                // Auto-save to database
                saveParticipantsToDB(tname);
            } else {
                alert("No valid participants found in the file.\n\nPlease check:\n- Column A should contain names\n- Column B should contain ELO ratings (numbers only)\n- No headers should be present");
            }
            
        } catch (error) {
            console.error("Error parsing file:", error);
            console.error("Error details:", error.message);
            alert("Error reading file: " + error.message + "\n\nPlease check the format:\n- Column A: Name\n- Column B: ELO (number)\n- No headers needed\n- Save as .xlsx or .csv");
        }
    };

    reader.onerror = function(error) {
        console.error("File reading error:", error);
        alert("Failed to read file. Please try again.");
    };

    reader.readAsArrayBuffer(file);
    fileInput.value = "";
    return false;
}

</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
