<!DOCTYPE html>
<html lang="en">
<head>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tournament Rounds</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
<style>

body {
    background: url('{{ url_for('static', filename='chessboard.jpg') }}') no-repeat center center fixed;
    background-size: cover;
    min-height: 100vh;
    padding: 20px;
}

.container {
    max-width: 1200px;
    background: white;
    border-radius: 15px;
    padding: 30px;
    box-shadow: 0 10px 40px rgba(0,0,0,0.3);
}
.round-card {
    background: #f8f9fa;
    border-left: 5px solid #667eea;
    margin-bottom: 20px;
}
.round-header {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    color: white;
    font-weight: bold;
}
.match-row:hover {
    background-color: #e9ecef;
}
.bye-alert {
    background: #fff3cd;
    border-left: 4px solid #ffc107;
}
.btn-generate {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    border: none;
    color: white;
    padding: 12px 30px;
    font-weight: bold;
}
.btn-generate:hover {
    opacity: 0.9;
    color: white;
}
</style>
</head>
<body>

<div class="container">
    <h1 class="mb-4 text-center" style="color: #667eea;">Tournament Rounds Manager</h1>
    <!-- ADD THIS DIV FOR STANDINGS DISPLAY -->
    <div id="tournamentListBox"></div>

    <!-- Alert Messages -->
    {% if error_message %}
    <div class="alert alert-danger alert-dismissible fade show" role="alert">
        <strong>Error!</strong> {{ error_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    {% if success_message %}
    <div class="alert alert-success alert-dismissible fade show" role="alert">
        <strong>Success!</strong> {{ success_message }}
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
    {% endif %}
    
    <!-- Tournament Selection -->
    <form method="POST" class="mb-4">
        <div class="row g-3 align-items-end">
            <div class="col-md-8">
                <label class="form-label fw-bold">Select Tournament:</label>
                <select name="tournament_id" required class="form-select" id="tournamentSelect">
                    <option value="">-- Choose a Tournament --</option>
                    {% for t in tournaments %}
                    <option value="{{ t.id }}" data-name="{{ t.name }}" {% if selected_tournament and t.id == selected_tournament.id %}selected{% endif %}>
                        {{ t.name }} ({{ t.rounds }} rounds)
                    </option>
                    {% endfor %}
                </select>
            </div>
            <div class="col-md-4">
                <button type="submit" name="action" value="load_tournament" class="btn btn-primary w-80">
                    Load Rounds
                </button>
                <a href="{{ url_for('setupdashboard') }}" class="btn btn-info w-80">Back</a>
                <button type = "button" class="btn btn-success w-80" onclick="showStandingsSelector()">Standings</button>
            </div>
        </div>
    </form>

    {% if selected_tournament %}
    <hr class="my-4">
    
    <div class="alert alert-info">
        <strong>{{ selected_tournament.name }}</strong> | 
        Total Rounds: {{ selected_tournament.rounds }} | 
        Win: {{ selected_tournament.win_points }}pts | 
        Draw: {{ selected_tournament.draw_points }}pts | 
        Loss: {{ selected_tournament.loss_points }}pts
    </div>

        <!-- Display all rounds -->
    <div id="roundsContainer">
    {% for round in rounds_data %}
    <div class="card round-card">
        <div class="card-header round-header">
            <h4 class="mb-0">Round {{ round.round_number }}</h4>
        </div>
        <div class="card-body">
            
            {% if round.bye_player and round.bye_players|length > 0 %}
            <div class="alert bye-alert">
                <strong>üèÜ Bye Player:</strong> 
                {% for bye_name in round.bye_players %}
                    {{ bye_name }}{% if not loop.last %}, {% endif %}
                {% endfor %}
                (awarded {{ selected_tournament.win_points }} point{% if selected_tournament.win_points != 1 %}s{% endif %} each)
            </div>
            {% endif %}

            <form method="POST">
                <input type="hidden" name="tournament_id" value="{{ selected_tournament.id }}">
                <input type="hidden" name="round_number" value="{{ round.round_number }}">
                <input type="hidden" name="action" value="save_results">

                <table class="table table-striped table-hover">
                    <thead class="table-dark">
                        <tr>
                            <th style="width: 35%;">White Player</th>
                            <th style="width: 35%;">Black Player</th>
                            <th style="width: 30%;">Result</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for match in round.pairings %}
                        <tr class="match-row">
                            <td>{{ match.white_name }}</td>
                            <td>{{ match.black_name }}</td>
                            <td>
                                {% set result_key = match.white_id|string + '-' + match.black_id|string %}
                                {% if round.results.get(result_key) %}
                                    <span class="badge bg-success fs-6">
                                        {% if round.results[result_key] == 'white' %}
                                            ‚úì White Won
                                        {% elif round.results[result_key] == 'black' %}
                                            ‚úì Black Won
                                        {% elif round.results[result_key] == 'draw' %}
                                            ‚öñ Draw
                                        {% elif round.results[result_key] == 'bye_white' %}
                                            ‚úì Bye (White)
                                        {% elif round.results[result_key] =='bye_black' %}
                                            ‚úì Bye (Black)
                                        {% endif %}
                                    </span>
                                {% else %}
                                    <div class="btn-group" role="group">
                                        <input type="radio" class="btn-check" name="winner_{{ match.white_id }}-{{ match.black_id }}"
                                                value="bye_white" id="byew{{ match.white_id }}-{{ match.black_id }}">
                                        <label class="btn btn-outline-warning btn-sm" for="byew{{ match.white_id }}-{{ match.black_id }}">Bye (W)</label>
                            
                                        <input type="radio" class="btn-check" name="winner_{{ match.white_id }}-{{ match.black_id }}" 
                                               value="white" id="w{{ match.white_id }}-{{ match.black_id }}" required>
                                        <label class="btn btn-outline-success btn-sm" for="w{{ match.white_id }}-{{ match.black_id }}">White</label>
                                        
                                        <input type="radio" class="btn-check" name="winner_{{ match.white_id }}-{{ match.black_id }}" 
                                               value="draw" id="d{{ match.white_id }}-{{ match.black_id }}">
                                        <label class="btn btn-outline-secondary btn-sm" for="d{{ match.white_id }}-{{ match.black_id }}">Draw</label>
                                        
                                        <input type="radio" class="btn-check" name="winner_{{ match.white_id }}-{{ match.black_id }}" 
                                               value="black" id="b{{ match.white_id }}-{{ match.black_id }}">
                                        <label class="btn btn-outline-danger btn-sm" for="b{{ match.white_id }}-{{ match.black_id }}">Black</label>

                                        <input type="radio" class="btn-check" name="winner_{{ match.white_id }}-{{ match.black_id }}" 
                                                value="bye_black" id="byeb{{ match.white_id }}-{{ match.black_id }}">
                                        <label class="btn btn-outline-warning btn-sm" for="byeb{{ match.white_id }}-{{ match.black_id }}">Bye (B)</label>
                                    </div>
                                {% endif %}
                            </td>
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>

                {% set result_key_check = round.pairings[0].white_id|string + '-' + round.pairings[0].black_id|string if round.pairings else '' %}
                {% if round.pairings and not round.results.get(result_key_check) %}
                <button type="submit" class="btn btn-success">
                    Save Round {{ round.round_number }} Results
                </button>
                {% endif %}
            </form>

        </div>
    </div>
    {% endfor %}
    
    <!-- Generate Next Round Button -->
    {% if rounds_data|length < selected_tournament.rounds %}
    <div class="text-center mt-4">
        <form method="POST">
            <input type="hidden" name="tournament_id" value="{{ selected_tournament.id }}">
            <input type="hidden" name="action" value="generate_next_round">
            <button type="submit" class="btn btn-generate btn-lg">
                Generate Round {{ rounds_data|length + 1 }}
            </button>
        </form>
    </div>
    {% elif rounds_data|length == selected_tournament.rounds %}
    <div class="alert alert-success text-center mt-4">
        <h4>üèÅ Tournament Complete!</h4>
        <p>All {{ selected_tournament.rounds }} rounds have been played.</p>
    </div>
    {% endif %}
    </div> <!-- Closes roundsContainer -->

    {% endif %}

</div> <!-- Closes main container -->


<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>

function showStandingsSelector() {
    const tournamentSelect = document.getElementById('tournamentSelect');
    const selectedOption = tournamentSelect ? tournamentSelect.options[tournamentSelect.selectedIndex] : null;
    
    if (selectedOption && selectedOption.value) {
        const tournamentName = selectedOption.getAttribute('data-name');
        const tournamentId = selectedOption.value;
        
        window.scrollTo({ top: 0, behavior: 'smooth' });
        
        // Clear previous content
        document.getElementById("tournamentListBox").innerHTML = '';
        document.getElementById("roundsContainer").innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Loading rounds...</p></div>';
        
        // Load BOTH standings and rounds
        loadStandings(tournamentName);
        loadRounds(tournamentId, tournamentName);
    } else {
        alert("Please select a tournament first!");
    }
}

function loadStandings(tname) {
    let box = document.getElementById("tournamentListBox");
    box.innerHTML = '<div class="text-center"><div class="spinner-border text-primary" role="status"></div><p>Loading standings...</p></div>';
    
    fetch(`/api/tournament/${encodeURIComponent(tname)}/standings`)
    .then(response => response.json())
    .then(data => {
        if (data.error) {
            alert(data.error);
            box.innerHTML = '';
            return;
        }

        let html = `
        <div class="card bg-dark text-white mt-4 mb-4 p-3">
            <div class="d-flex justify-content-between align-items-center mb-3">
                <h4>${data.tournament} - Standings</h4>
                <div>
                    <button class="btn btn-sm btn-secondary" onclick="hideStandings()">
                        Close Standings
                    </button>
                    <button class="btn btn-sm btn-danger ms-2" onclick="exportToExcel('${data.tournament}')">
                        Export 
                    </button>
                    <span class="badge bg-info fs-6 ms-2">Round ${data.current_round} of ${data.total_rounds}</span>
                </div>
            </div>
            <div class="table-responsive">
                <table class="table table-striped table-hover">
                    <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
                        <tr>
                            <th>#</th>
                            <th>Name</th>
                            <th>ELO</th>
                            <th>Score</th>
                            <th>Buchholz</th>
                            <th>Buch Cut-1</th>
                            <th>Games</th>
                            <th>W/B</th>
                        </tr>
                    </thead>
                    <tbody>`;

        data.standings.forEach(player => {
            const rowStyle = player.bye_count > 0 ? 'background-color: #fff3cd;' : '';
            
            html += `
                <tr style="${rowStyle}">
                    <td><strong>${player.rank}</strong></td>
                    <td>${player.name}</td>
                    <td>${player.elo}</td>
                    <td><strong style="color: #667eea;">${player.score}</strong></td>
                    <td>${player.buchholz.toFixed(1)}</td>
                    <td>${player.buchholz_cut1.toFixed(1)}</td>
                    <td>${player.games_played}</td>
                    <td>${player.white_count}/${player.black_count}</td>
                </tr>`;
        });

        html += `
                    </tbody>
                </table>
            </div>
        </div>`;

        box.innerHTML = html;
    })
    .catch(err => {
        console.error("Error loading standings:", err);
        alert("Failed to load standings");
        box.innerHTML = '';
    });
}

function loadRounds(tournamentId, tournamentName) {
    let container = document.getElementById("roundsContainer");
    
    // Also fetch tournament info to get total rounds
    Promise.all([
        fetch(`/api/tournament/${tournamentId}/rounds`),
        fetch(`/api/tournaments`)
    ])
    .then(([roundsResponse, tournamentsResponse]) => 
        Promise.all([roundsResponse.json(), tournamentsResponse.json()])
    )
    .then(([roundsData, tournamentsData]) => {
        if (roundsData.status !== 'ok' || !roundsData.rounds) {
            alert('Failed to load rounds');
            container.innerHTML = '<div class="alert alert-danger">Failed to load rounds</div>';
            return;
        }

        // Find the tournament to get total rounds
        const tournament = tournamentsData.tournaments.find(t => t.id == tournamentId);
        const totalRounds = tournament ? tournament.rounds : 0;

        let html = '';
        
        if (roundsData.rounds.length > 0) {
            roundsData.rounds.forEach(round => {
                html += `
                <div class="card round-card">
                    <div class="card-header round-header">
                        <h4 class="mb-0">Round ${round.round_number}</h4>
                    </div>
                    <div class="card-body">`;
                
                if (round.bye_player) {
                    html += `
                        <div class="alert bye-alert">
                            <strong>üèÜ Bye Player:</strong> ${round.bye_player}
                        </div>`;
                }
                
                html += `
                        <table class="table table-striped table-hover">
                            <thead class="table-dark">
                                <tr>
                                    <th style="width: 35%;">White Player</th>
                                    <th style="width: 35%;">Black Player</th>
                                    <th style="width: 30%;">Result</th>
                                </tr>
                            </thead>
                            <tbody>`;
                
                round.pairings.forEach(pairing => {
                    html += `
                        <tr class="match-row">
                            <td>${pairing.white_name}</td>
                            <td>${pairing.black_name}</td>
                            <td>`;
                    
                    const resultKey = `${pairing.white_id}-${pairing.black_id}`;
                    const result = round.results ? round.results[resultKey] : null;
                    
                    if (result) {
                        let resultText = '';
                        let badgeClass = 'bg-success';
                        
                        if (result === 'white') {
                            resultText = '‚úì White Won';
                        } else if (result === 'black') {
                            resultText = '‚úì Black Won';
                        } else if (result === 'draw') {
                            resultText = '‚öñ Draw';
                        } else if (result === 'bye_white') {
                            resultText = '‚úì Bye (White)';
                            badgeClass = 'bg-warning';
                        } else if (result === 'bye_black') {
                            resultText = '‚úì Bye (Black)';
                            badgeClass = 'bg-warning';
                        }
                        
                        html += `<span class="badge ${badgeClass} fs-6">${resultText}</span>`;
                    } else {
                        html += '<span class="badge bg-secondary">Pending</span>';
                    }
                    
                    html += `
                            </td>
                        </tr>`;
                });
                
                html += `
                            </tbody>
                        </table>
                    </div>
                </div>`;
            });
        } else {
            html = '<div class="alert alert-info">No rounds generated yet.</div>';
        }
        
        // ‚ú® ADD THIS: Generate Next Round button
        if (roundsData.rounds.length < totalRounds) {
            html += `
                <div class="text-center mt-4">
                    <form method="POST">
                        <input type="hidden" name="tournament_id" value="${tournamentId}">
                        <input type="hidden" name="action" value="generate_next_round">
                        <button type="submit" class="btn btn-generate btn-lg">
                            Generate Round ${roundsData.rounds.length + 1}
                        </button>
                    </form>
                </div>`;
        } else if (roundsData.rounds.length === totalRounds) {
            html += `
                <div class="alert alert-success text-center mt-4">
                    <h4>üèÅ Tournament Complete!</h4>
                    <p>All ${totalRounds} rounds have been played.</p>
                </div>`;
        }
        
        container.innerHTML = html;
    })
    .catch(err => {
        console.error("Error loading rounds:", err);
        alert("Failed to load rounds");
        container.innerHTML = '<div class="alert alert-danger">Error loading rounds</div>';
    });
}

function hideStandings() {
    document.getElementById("tournamentListBox").innerHTML = '';
    const alertInfo = document.querySelector('.alert.alert-info');
    if (alertInfo) {
        alertInfo.scrollIntoView({ behavior: 'smooth', block: 'start' });
    }
}

function exportToExcel(tournamentName) {
    // Your existing exportToExcel function stays the same
    let wb = XLSX.utils.book_new();
    
    fetch(`/api/tournament/${encodeURIComponent(tournamentName)}/standings`)
    .then(res => res.json())
    .then(standingsData => {
        fetch(`/api/tournaments`)
        .then(res => res.json())
        .then(allTournaments => {
            const tournament = allTournaments.tournaments.find(t => t.name === tournamentName);
            return fetch(`/api/tournament/${tournament.id}/rounds`);
        })
        .then(res => res.json())
        .then(roundsData => {
            const standingsTableData = [];
            standingsTableData.push(['Rank', 'Name', 'ELO', 'Score', 'Buchholz', 'Buch Cut-1', 'Games', 'Byes', 'W/B']);
            
            standingsData.standings.forEach(player => {
                standingsTableData.push([
                    player.rank,
                    player.name,
                    player.elo,
                    player.score,
                    player.buchholz.toFixed(1),
                    player.buchholz_cut1.toFixed(1),
                    player.games_played,
                    player.bye_count || 0,
                    `${player.white_count}/${player.black_count}`
                ]);
            });
            
            const standingsSheet = XLSX.utils.aoa_to_sheet(standingsTableData);
            standingsSheet['!cols'] = [
                { wch: 6 }, { wch: 20 }, { wch: 8 }, { wch: 8 }, 
                { wch: 12 }, { wch: 12 }, { wch: 8 }, { wch: 6 }, { wch: 8 }
            ];
            XLSX.utils.book_append_sheet(wb, standingsSheet, 'Standings');
            
            if (roundsData.rounds && roundsData.rounds.length > 0) {
                roundsData.rounds.forEach(round => {
                    const roundTableData = [];
                    roundTableData.push(['White', 'Black', 'Result']);
                    
                    round.pairings.forEach(pairing => {
                        let result = 'Pending';
                        if (pairing.result === 'white') result = 'White Won';
                        else if (pairing.result === 'black') result = 'Black Won';
                        else if (pairing.result === 'draw') result = 'Draw';
                        else if (pairing.result === 'bye_white') result = 'White BYE Win';
                        else if (pairing.result === 'bye_black') result = 'Black BYE Win';
                        
                        roundTableData.push([
                            pairing.white_name,
                            pairing.black_name,
                            result
                        ]);
                    });
                    
                    const roundSheet = XLSX.utils.aoa_to_sheet(roundTableData);
                    roundSheet['!cols'] = [{ wch: 25 }, { wch: 25 }, { wch: 15 }];
                    XLSX.utils.book_append_sheet(wb, roundSheet, `Round ${round.round_number}`);
                });
            }
            
            const fileName = `${tournamentName}_Tournament_Standings_&_Rounds.xlsx`;
            XLSX.writeFile(wb, fileName);
        })
        .catch(err => {
            console.error("Error fetching rounds:", err);
            alert("Failed to export: Could not fetch rounds data");
        });
    })
    .catch(err => {
        console.error("Error fetching standings:", err);
        alert("Failed to export: Could not fetch standings data");
    });
}

</script>
</body>
</html>